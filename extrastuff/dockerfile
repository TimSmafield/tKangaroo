# ---- build stage ----
FROM nvidia/cuda:12.4.1-devel-ubuntu22.04 AS build
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends \
    git build-essential libgmp-dev ca-certificates \
 && rm -rf /var/lib/apt/lists/*

# Makefile expects legacy paths; provide shims
RUN ln -s /usr/local/cuda /usr/local/cuda-8.0 && \
    ln -s /usr/bin/g++ /usr/bin/g++-4.8

WORKDIR /opt
RUN git clone --depth=1 https://github.com/TimSmafield/tKangaroo.git Kangaroo
WORKDIR /opt/Kangaroo

# Build with GPU enabled (set CCAP for your GPU: 61=GTX1060, 75=Turing, 86=RTX30, 89=RTX40)
ARG CCAP=61
RUN make clean || true \
 && make -j"$(nproc)" gpu=1 ccap=${CCAP} all \
 && BIN="$(find . -maxdepth 4 -type f -perm -111 \( -name 'Kangaroo*' -o -name 'kangaroo*' \) | head -n1)" \
 && echo "Built binary: $BIN" \
 && mkdir -p /out \
 && install -m755 "$BIN" /out/kangaroo

# ---- runtime stage ----
FROM nvidia/cuda:12.4.1-runtime-ubuntu22.04
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgomp1 libgmp10 ca-certificates \
 && rm -rf /var/lib/apt/lists/*

ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility

WORKDIR /work
COPY --from=build /out/kangaroo /usr/local/bin/kangaroo
ENTRYPOINT ["kangaroo"]
